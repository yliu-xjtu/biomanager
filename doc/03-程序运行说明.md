# 程序运行说明

## 一、环境要求

- Python 3.10 或更高版本
- Windows 10/11（当前仅测试 Windows 环境）

## 二、安装依赖

```bash
pip install PySide6 PyMuPDF requests matplotlib
```

依赖说明：
| 包名 | 用途 |
|------|------|
| PySide6 | GUI 框架 |
| PyMuPDF (fitz) | PDF 解析与文本提取 |
| requests | HTTP 请求（DOI 解析、OCR） |
| matplotlib | 统计图表绘制 |

## 三、运行程序

```bash
python app/app.py
```

或双击运行（需配置环境变量）：
```bash
C:\Python310\python.exe C:\path\to\biomanager\app\app.py
```

## 四、操作步骤

### 4.1 首次启动

1. 运行 `app/app.py`
2. 弹出启动对话框，选择"新建数据库"或"打开数据库"
3. 选择数据库保存位置（建议放在文献库根目录）
4. 主窗口打开，显示三个标签页：论文、专利、软著

### 4.2 扫描文献库

1. 点击顶部工具栏 **"选择文件夹扫描"**
2. 在弹出的对话框中选择包含 PDF 文件的根目录
3. 程序递归扫描所有子目录中的 `.pdf` / `.PDF` 文件
4. 自动识别文件类型（论文/专利证书/软著证书）
5. 扫描进度显示在进度条和状态栏
6. 扫描完成后，文献显示在对应的标签页中

### 4.3 查看与编辑

| 操作 | 说明 |
|------|------|
| 单击行 | 右侧面板显示详情，可编辑 |
| 双击行 / Enter | 调用系统默认程序打开 PDF 文件 |
| 拖动列头 | 调整列顺序 |
| 点击列头 | 按该列排序 |
| 搜索框 | 输入关键词筛选 |
| 标签下拉框 | 按标签筛选 |

### 4.4 快捷键

| 快捷键 | 功能 |
|--------|------|
| Ctrl+O | 打开数据库 |
| Ctrl+N | 新建数据库 |
| Ctrl+W | 关闭数据库 |
| F5 | 刷新数据库 |
| Ctrl+F | 搜索框聚焦 |
| Enter / 双击 | 打开 PDF/证书 |
| Delete | 删除选中项目 |
| Ctrl+S | 保存修改 |
| Ctrl+Up | 上移选中项 |
| Ctrl+Down | 下移选中项 |
| Ctrl+1/2/3 | 切换到论文/专利/软著标签 |
| Ctrl+Q | 退出程序 |

### 4.5 论文管理

#### 手动触发 OCR
1. 在表格中找到 `Status` 为 `needs_ocr` 的行
2. 单击该行，在右侧面板点击 **"触发 OCR"** 按钮
3. 注意：需先在 `config.py` 中配置 `OCR_API_KEY`

#### 重新查找 DOI
1. 在表格中找到需要更新的行
2. 单击该行，在右侧面板点击 **"按DOI更新"** 按钮
3. 程序将重新查询 Crossref/OpenAlex 并更新结果

#### 更新影响因子
1. 选择需要更新的论文（可多选）
2. 点击右侧面板的 **"更新IF"** 按钮
3. 程序将查询期刊影响因子并更新

#### 提取摘要
1. 选择论文后，点击菜单 **工具 → 查看 → 论文详情**
2. 在论文详情对话框中点击 **"从PDF提取"** 按钮
3. 程序自动识别并提取摘要

### 4.6 专利管理

1. 切换到"专利"标签页
2. 扫描包含专利证书 PDF 的文件夹
3. 程序自动识别专利证书并提取信息
4. 可手动编辑专利详情（专利号、发明人、授权日等）
5. 支持标签分类管理

### 4.7 软著管理

1. 切换到"软著"标签页
2. 扫描包含软著证书 PDF 的文件夹
3. 程序自动识别软著证书
4. 点击 **"触发OCR"** 识别证书内容
5. 点击 **"解析并应用"** 自动填充表单
6. 支持标签分类管理

### 4.8 导出文献

**菜单 → 文件：**
| 菜单项 | 功能 |
|--------|------|
| 导出 BibTeX | 将选中论文导出为 `.bib` 文件 |
| 导出 RIS | 将选中论文导出为 `.ris` 文件（EndNote/Zotero 兼容） |
| 导出 GB/T 7714 | 将选中论文导出为 `.txt` 文件 |
| 复制 GB/T 7714 | 将 GB/T 7714 格式复制到剪贴板 |
| 导出专利 CSV | 将专利导出为 CSV 文件 |
| 导出软著 CSV | 将软著导出为 CSV 文件 |

### 4.9 统计报表

**菜单 → 工具 → 统计报表：**
- 年度发文统计：按年份统计论文数量
- 期刊分布统计：统计各期刊发文数量
- 类型分布统计：统计论文/专利/软著数量

## 五、配置说明

编辑 `config.py` 可自定义以下配置：

```python
# OCR API 配置
OCR_API_KEY = ""           # OCR 服务 API Key
OCR_API_URL = "https://api.example.com/v1/chat/completions"  # OCR 服务地址

# DOI 解析配置
RESOLVER_EMAIL = "researcher@example.com"  # 建议填写真实邮箱
RESOLVER_USER_AGENT = "BioManager/1.0 (Python)"

# 评分阈值
DOI_MATCH_THRESHOLD = 80   # 低于此分数不自动写入 DOI
```

## 六、代理设置

如需使用代理访问 Crossref/OpenAlex：
1. 点击菜单 **设置 → 代理设置**
2. 输入代理地址（如 `http://127.0.0.1:7890`）
3. 点击"测试连接"验证代理可用性
4. 点击"保存"

## 七、日志文件

程序运行日志保存在 `app.log`，包含：
- 扫描进度
- DOI 解析结果
- OCR 识别结果
- 错误信息
- 数据库操作记录

## 八、打包为可执行文件

### 方法一：使用 build.bat（推荐）
```bash
build.bat
```

### 方法二：使用 PyInstaller
```bash
pip install pyinstaller
pyinstaller build.spec
```

打包后的 `dist/BioManager.exe` 可直接运行，无需 Python 环境。

## 九、常见问题

| 问题 | 解决方案 |
|------|----------|
| 扫描很慢 | 检查网络，或配置代理 |
| DOI 解析失败 | 检查网络连接和代理设置 |
| OCR 按钮无效 | 需在 `config.py` 配置 `OCR_API_KEY` |
| 程序无响应 | 扫描大文件夹时会阻塞 UI，请耐心等待 |
| 无法打开 PDF | 检查 PDF 文件路径是否有效 |
| 表格显示乱码 | 检查系统区域设置，程序支持 UTF-8 |
| 标签筛选无内容 | 需先为文献添加标签并保存 |

## 十、状态说明

| Status | 含义 |
|--------|------|
| pending | 等待解析 |
| success | 解析成功 |
| needs_review | 需要人工审核（DOI 置信度 < 80） |
| needs_ocr | 需要 OCR（文本提取字符数 < 200） |
| failed | 解析失败（查看 parse_error 字段） |

## 十一、文件结构说明

```
biomanager/
├── app/                 # 程序入口
│   └── app.py
├── ui/                  # 用户界面
│   ├── main_window.py   # 主窗口
│   ├── table_model.py   # 论文表格模型
│   ├── patent_table_model.py   # 专利表格模型
│   ├── software_table_model.py # 软著表格模型
│   ├── detail_panel.py  # 论文详情面板
│   ├── patent_detail_panel.py  # 专利详情面板
│   ├── software_detail_panel.py # 软著详情面板
│   └── theme.py         # 主题样式
├── core/                # 核心逻辑
│   ├── scanner.py       # 文件扫描
│   ├── extractor.py     # 元数据抽取
│   ├── resolver.py      # DOI 在线解析
│   ├── ocr.py           # OCR 接口
│   ├── bibtex.py        # BibTeX 生成
│   ├── export.py        # 导出功能
│   ├── proxy.py         # 代理配置
│   ├── journal_impact.py # 影响因子查询
│   └── llm_parser.py    # LLM 解析
├── db/                  # 数据层
│   ├── schema.sql       # 数据库结构
│   └── database.py      # 数据库操作
├── csl/                 # 引用样式
│   └── gb-t-7714-2015.csl
├── config.py            # 配置文件
├── startup_dialog.py    # 启动对话框
├── build.spec           # PyInstaller 打包配置
├── build.bat            # 打包脚本
├── *.db                 # 数据库文件（运行后生成）
└── app.log              # 日志文件（运行后生成）
```
