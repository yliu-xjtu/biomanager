# 需求规格说明书 V1.0

## 一、项目目标

- 纯 Python（>=3.10）桌面程序，PySide6 UI，SQLite（sqlite3）数据库
- 用户选择本地文件夹，递归扫描所有 PDF 文件，构建本地文献库
- 自动抽取/补全文献元数据：title/authors/year/venue/doi/url
- 支持：无 DOI 文献尽量在线查找 DOI 并自动补全（Crossref + OpenAlex）
- 支持：扫描版 PDF 在线 OCR（预留 API Key，不内置密钥，OCR 不自动执行需用户手动触发）
- UI 表格管理 + 右侧详情编辑
- 导出：BibTeX + GB/T 7714-2015 引用文本（用 CSL 渲染）

## 二、非目标（V1.0 不做）

- 云同步/账号、全文搜索、批注笔记、影响因子、移动端/Web、PDF 内预览（只需双击打开外部 PDF）

## 三、技术约束（必须）

| 类别 | 技术选型 |
|------|----------|
| UI | PySide6 |
| DB | sqlite3 标准库 |
| PDF | PyMuPDF (fitz) |
| 网络 | 离线优先，联网只用于补全 |
| 在线补全 | Crossref + OpenAlex REST |
| 引用 | BibTeX + CSL（GB/T 7714-2015.csl） |

## 四、核心流程

```
1) 启动：初始化数据库→加载已有数据→不自动扫描
2) 用户选择文件夹：递归扫描 *.pdf
3) 增量更新：基于 path + size + mtime；未变化不得重新解析
4) 新/变更文件进入解析队列
5) 抽取优先级：DOI(正则)→PDF metadata(title/author)→年份正则→OCR（文本不可读时）
6) OCR 触发：首页可提取字符数<200 → needs_ocr；OCR 不自动执行
7) 无 DOI 在线补全：Crossref query.bibliographic 取 Top5 → 评分（标题40/年份20/第一作者20/venue20）
   - 分数>=80 自动写入 DOI 并补全
   - <80 标记 needs_review（不自动写入）
8) UI：表格列固定顺序：Title, Authors, Year, Venue, DOI, File Path, Status, Confidence
   - 单击行：右侧详情可编辑并写回 DB
   - 双击行：外部打开 PDF
   - 低置信度高亮
   - 支持多选导出
9) 导出：BibTeX（选中/全部）；GB/T 7714（CSL 渲染，输出 txt 或复制）
```

## 五、状态机（parse_status 取值固定）

- `pending` / `success` / `needs_review` / `needs_ocr` / `failed`

**原则**：任何失败不得崩溃，异常写入 DB 并可解释显示。

## 六、数据库字段（不可更改）

### pdf_files
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PRIMARY KEY | 自增 ID |
| path | TEXT UNIQUE | 文件路径 |
| sha256 | TEXT | 文件哈希 |
| size | INTEGER | 文件大小 |
| mtime | REAL | 修改时间 |
| parse_status | TEXT | 解析状态 |
| parse_error | TEXT | 解析错误信息 |
| added_at | REAL | 添加时间 |
| last_scanned_at | REAL | 最后扫描时间 |

### papers
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PRIMARY KEY | 自增 ID |
| title | TEXT | 标题 |
| authors | TEXT | 作者（; 分隔） |
| year | INTEGER | 年份 |
| venue | STRING | 出版场所 |
| doi | TEXT UNIQUE | DOI |
| url | TEXT | 链接 |
| entry_type | TEXT | 文献类型 |
| bibtex_key | TEXT | BibTeX 键 |
| confidence | REAL | 置信度 |
| source | TEXT | 来源 |
| created_at | REAL | 创建时间 |
| updated_at | REAL | 更新时间 |

### paper_files
| 字段 | 类型 | 说明 |
|------|------|------|
| paper_id | INTEGER | 文献 ID |
| pdf_file_id | INTEGER | PDF 文件 ID |

## 七、项目结构（必须遵守）

```
app/
├── app.py
├── ui/
│   ├── main_window.py
│   ├── table_model.py
│   └── detail_panel.py
├── core/
│   ├── scanner.py
│   ├── extractor.py
│   ├── ocr.py
│   ├── resolver.py
│   └── bibtex.py
├── db/
│   ├── schema.sql
│   └── database.py
├── csl/
│   └── gb-t-7714-2015.csl
└── config.py   # OCR/网络 API Key 占位
```

## 八、默认规则（需求不明确时按此执行）

| 规则 | 说明 |
|------|------|
| 扫描 | 递归子目录，忽略非 pdf；pdf 扩展名大小写不敏感 |
| sha256 | 对整个文件做 hash（稳，允许慢一点） |
| 网络请求 | 超时 10s，失败重试 2 次（指数退避），失败不崩溃只标记 needs_review/failed |
| 作者存储 | papers.authors 用 "; " 分隔（例如 "A B; C D"） |
| bibtex_key | FirstAuthorYearShortTitle（短标题取前 6-10 个单词拼接，去符号小写） |
| entry_type | 默认 article；若 venue 包含 "Proceedings"/"Conference"/"CCS"/"NDSS" 等关键词则用 inproceedings（仅启发式） |
| CSL | 必须支持 GB/T 7714-2015 输出；样式文件从 csl/gb-t-7714-2015.csl 读取 |
| UI | 表格可排序、可搜索（搜索框默认匹配 title/authors/doi/venue） |
| OCR | core/ocr.py 只实现接口与一个示例 provider（例如 HTTP POST 占位），不绑定任何具体厂商；API key 从 config.py 读取 |
